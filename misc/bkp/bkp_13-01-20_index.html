<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <title>Simulador</title>
        <link href="css/estilo.css" rel="stylesheet"/>
        <script src="Scripts/jquery.js"></script>
        <script src="Scripts/jquery-ui.js"></script>
        <script src="Scripts/jcanvas.js"></script>
        <script src="modelo/processador1/cfg.js"></script>
        <script>
            function valor(el,value){
                if(value==undefined){
                    return $('[el="'+el+'"]').ler();
                }else{
                    $('[el="'+el+'"]').gravar(value);
                }
            }
            function design_mode(){
                $('.draggable').draggable({ containment: "#processador", scroll: false, grid: [ 20,20 ]});
            }
            function design_mode_end(){
                var positions="";
                var left= Math.ceil($('#processador').offset().left);
                $('.draggable').each(function(){
                    positions+=$(this).attr('el')+":\r\n"
                    var offset=$(this).offset();
                    positions+="{\r\nleft:"+(Math.ceil(offset.left)-left)+"px;\r\ntop:"+offset.top+"px;\r\n}\r\n";
                    $(this).draggable( "destroy" ).attr('l',(Math.ceil(offset.left))-left);
                });
                $(window).resize();
                alert(positions);
            }
            function barramento_position(start,end){
                var startobj=$('[el="'+start+'"]');
                var endobj=$('[el="'+end+'"]');
    
                if($(startobj).offset().left<$(endobj).offset().left){
                    startx=Math.ceil($(startobj).offset().left);
                    endx=Math.ceil($(endobj).offset().left+$(endobj).width());
        
                    width=(endx-startx);
        
                    canvas_start_x=Math.ceil($(startobj).width())/2;
                    canvas_end_x=(width-Math.ceil($(endobj).width())/2)-canvas_start_x;
                }else{
                    startx=Math.ceil($(endobj).offset().left);
                    endx=Math.ceil($(startobj).offset().left+$(startobj).width());
        
                    width=(endx-startx);
        
                    canvas_start_x=Math.ceil($(endobj).width())/2;
                    canvas_end_x=(width-Math.ceil($(startobj).width())/2)-canvas_start_x;
                }
    
                if($(startobj).offset().top<$(endobj).offset().top){
                    starty=Math.ceil($(startobj).offset().top);
                    endy=Math.ceil($(endobj).offset().top+$(endobj).height());
        
                    height=(endy-starty);
        
                    canvas_start_y=Math.ceil($(startobj).height())/2;
                    canvas_end_y=(height-Math.ceil($(endobj).height())/2)-canvas_start_y;
                }else{
                    starty=Math.ceil($(endobj).offset().top);
                    endy=Math.ceil($(startobj).offset().top+$(startobj).height());
        
                    height=(endy-starty);
        
                    canvas_start_y=Math.ceil($(endobj).height())/2;
                    canvas_end_y=(height-Math.ceil($(startobj).height())/2)-canvas_start_y;
                }     
    
    
                return {
                    'position':{
                        'left':startx,
                        'top':starty,
                        'width':width,
                        'height':height
                    },
                    'canvas':{
                        'start':{
                            'x':canvas_start_x,
                            'y':canvas_start_y
                        },
                        'end':{
                            'x':canvas_end_x,
                            'y':canvas_end_y
                        }
                    }
                };
            }
            function draw_barramento(){
                $('[el]').each(function(){
                    var id=$(this).attr('el');
                    if($(this).attr('barramento')!=""){
                        alert($(this).attr('barramento'))
                        var barramento = $(this).attr('barramento').split(',')
                        for(var i=0;i<barramento.length;i++){
                            if(barramento[i].trim()!=""){
                                var id_barramento=id+"_"+barramento[i];
                                var positions=barramento_position(id,barramento[i]);
                                var obj=$('<canvas></canvas>').addClass('linecanvas').attr({'id':id_barramento}).css(positions.position);

                                var canvas_line=positions.canvas;
                                $(obj).drawLine({
                                    strokeStyle: "#00ff00",
                                    strokeWidth: 3,
                                    x1: canvas_line.start.x, y1: canvas_line.start.y,
                                    x2: canvas_line.end.x, y2: canvas_line.end.y
                                })

                                $('body').append(obj);

                            }
                        }
                    }
                });
            }
            (function($){
                $.fn.memoria = function(processador){
                    var memoriaObj = $('<table></table>').addClass('memoria').attr({'id':'memoria_principal','el':processador.memoria.nome,'pointer':processador.memoria.apontador_endereco,'barramento':''});
                    memoriaObj.append("<tr><td>ADD</td><td>VAL</td></tr>");
                    var memoria = processador.memoria.size;
                    var val="";
                    for(var i=0;i<memoria.toString().length;i++){
                        val+="0"
                    }
                    for(var i=0;i<memoria;i++){
                        memoriaObj.append("<tr><td>"+i+"</td><td arr='"+i+"'>"+val+"</td></tr")
                    }
                    $(this).append(memoriaObj);
                }
                $.fn.display=function(id,processador){
                    var val="";
                    for(var i=0;i<=memoria.length;i++){
                        val+="0"
                    }
                    $(this).append("<li><div><span class='indicador_periferico'></span><span class='valor_periferico' id='"+id+"'>"+val+"</span><div></li>");
                    $(this).mostrar=function(id,val){
                        $("span#"+id).html(val);
                    }
                    return $(this);
                }
                $.fn.numberkeyboard=function(processador){
                    var divContainer=$('div').addClass('numberkeyboard');
                    $('body').append(divContainer);
                    var input=$('<input class="valor" id="valor" disabled="disabled">');
                    var backspace=$('<a class="backspace"></a>').click(function(){
                        var valor = input.val();
                        input.val(valor.substr(0,(valor.length-1)));
                    });
                    divContainer.append(input);
                    divContainer.append(backspace);
                    for(var i=0;i<10;i++){
                        divContainer.append('<a class="number" val="'+i+'">'+i+'</a>').click(function(){
                            var valor=$(this).attr('val');
                            input.val(input.val()+""+valor);
                        });
                    }
                    divContainer.append('<a class="confirm"></a>').click(function(){
                        $('[barramento="per"]').html(input.val());
                    });
                    return $(this);
                }
                $.fn.registrador=function(reg){
                    var memoria = reg.size;
                    var val="";
                    for(var i=0;i<memoria.toString().length;i++){
                        val+="0"
                    }
                    var el_reg=$('<div></div>').attr({'el':reg.nome,'pointer':'',l:reg.orientacao.x,'barramento':reg.barramento}).addClass('registrador draggable').css({'top':reg.orientacao.y,'left':reg.orientacao.x});
                    el_reg.append($('<div></div').addClass('nome').html(reg.nome_exibicao));
                    el_reg.append($('<div></div>').addClass('valor').html(val));
                    $(this).append(el_reg);
                }
                $.fn.gravar=function(value){
                    var pointer=$(this).attr('pointer');
                    if(pointer!=''){
                        var indicador=$('[el="'+pointer+'"]').ler();
                        $(this).find('[arr="'+indicador+'"]').html(value);
                    }else{
                        $(this).find('.valor').html(value);
                    }
                }
                $.fn.ler=function(){
                    var pointer=$(this).attr('pointer');
                    if(pointer!=''){
                        var indicador=$('[el="'+pointer+'"]').ler();
                        return $(this).find('[arr="'+indicador+'"]').html();
                    }else{
                        return $(this).find('.valor').html();
                    }
                }
                $.fn.auxiliares=function(reg){
                    
                    var memoria = reg.size;
                    var val="";
                    for(var i=0;i<memoria.toString().length;i++){
                        val+="0"
                    }
                    var el_reg=$('<div></div>').attr({'el':reg.nome,'pointer':reg.apontador_endereco,l:reg.orientacao.x,'barramento':reg.barramento}).addClass('registrador_auxiliar draggable').css({'top':reg.orientacao.y,'left':reg.orientacao.x});
                    var reg_tbl=$('<table></table>');
                    reg_tbl.append("<tr><td colspan='2'>"+reg.nome_exibicao+"</td></tr>");
                    reg_tbl.append("<tr><td>ADD</td><td>VAL</td></tr>");
                    
                    for(var i=0;i<reg.arr;i++){
                        reg_tbl.append("<tr><td>"+i+"</td><td arr='"+i+"'>"+val+"</td></tr")
                    }
                    el_reg.append(reg_tbl);
                    $(this).append(el_reg);
                }
                $.fn.unidade_funcional=function(unidade){
                    var unidadeObj=$('<div></div>').attr({'el':unidade.nome,'pointer':'',l:unidade.style.left,'barramento':''}).addClass('unidade_funcional draggable').css(unidade.style);
                    var regs=unidade.elementos;
                    for(var i=0;i<regs.length;i++){
                        var memoria = regs[i].size;
                        var val="";
                        for(var u=0;u<memoria.toString().length;u++){
                            val+="0"
                        }
                        var min_reg=$('<div></div>')
                        .attr({'el':regs[i].nome,'pointer':'','barramento':regs[i].barramento})
                        .addClass('registrador')
                        .css(regs[i].style);
                        
                        min_reg.append($('<div></div').addClass('nome').html(regs[i].nome_exibicao));
                        min_reg.append($('<div></div>').addClass('valor').html(val));
                        
                        unidadeObj.append(min_reg)
                    }
                    $(this).append(unidadeObj);
                }
                $(window).resize(function(){
                    var left= Math.ceil($('#processador').offset().left);
                    /*$('.draggable').each(function(){
                        var atualeft= Math.ceil($(this).attr('l'))+left;
                        $(this).css('left',atualeft);
                    });*/
                });
            })(jQuery)
            var col="";
            $(document).ready(function(){
                $('#memoria').memoria(processador)
                var registradores=processador.registradores;
                for(var i=0;i<registradores.length;i++){
                    $('#processador').registrador(registradores[i]);
                }
                var registradoresaux=processador.registradores_auxilixares;
                for(var i=0;i<registradoresaux.length;i++){
                    $('#processador').auxiliares(registradoresaux[i]);
                }
                var unidades_funcionais=processador.unidades_funcional;
                for(var i=0;i<unidades_funcionais.length;i++){
                    $('#processador').unidade_funcional(unidades_funcionais[i]);
                }
                $(window).resize();
            });
        </script>
    </head>
    <body>
        <div id="computador">
            <div id="memoria"></div>
            <div id="processador"></div>
            <div id="unidade_controle">
                <div id="clock_area">
                    <a class="button">-</a>
                    <input type="text" id="clock" value="1000"/>
                    <a class="button">+</a>
                </div>
                <a class="button">Start</a>
                <a class="button">Pause</a>
            </div>
            <div id="perifericos">
                <ul>
                    <li></li>
                    <li></li>
                    <li></li>
                </ul>
            </div>
        </div>
    </body>
</html>

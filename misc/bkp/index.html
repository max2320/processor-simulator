<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <title>Simulador</title>
        <link href="css/estilo.css" rel="stylesheet"/>
        <script src="Scripts/jquery.js"></script>
        <script src="Scripts/jquery-ui.js"></script>
        <script src="Scripts/jcanvas.js"></script>
        <script src="modelo/processador1/cfg.js"></script>
        <script>
            function copiar_valor(de,para){
                var de_value = valor(de);
                valor(para,de_value);
                if(de=='mem' || para=='mem'){
                    ativar_barramento(processador.memoria.apontador_endereco,'mem',true);
                    ativar_barramento(de,para,false);
                }else{
                    if(de=='per' || para=='per'){
                        stop_processamento();
                        var pointer=$('[el="per"]').attr('pointer');
                        var indicador=$('[el="'+pointer+'"]').ler();
                        var tipo=$('[el="per"]').find('[arr="'+indicador+'"]').attr('tipo');
                        console.log("$('[el=\"per\"]').find('[arr=\"'"+indicador+"'\"]')."+tipo+"('"+para+"');");
                        eval("$('[el=\"per\"]').find('[arr=\""+indicador+"\"]')."+tipo+"('"+para+"');")
                        ativar_barramento('ees','per',true);
                        ativar_barramento(de,para,false);
                    }else{
                        ativar_barramento(de,para);
                    }
                }
            }
            function valor(el,value){
                if(value==undefined){
                    return parseInt($('[el="'+el+'"]').ler());
                }else{
                    $('[el="'+el+'"]').gravar(value);
                }
            }
            function design_mode(){
                $('.draggable').draggable({ containment: "#processador", scroll: false, grid: [ 20,20 ]});
            }
            function design_mode_end(){
                var positions="";
                var left= Math.ceil($('#processador').offset().left);
                $('.draggable').each(function(){
                    positions+=$(this).attr('el')+":\r\n"
                    var offset=$(this).offset();
                    positions+="{\r\nleft:"+(Math.ceil(offset.left)-left)+"px;\r\ntop:"+offset.top+"px;\r\n}\r\n";
                    $(this).draggable( "destroy" ).attr('l',(Math.ceil(offset.left))-left);
                });
                $(window).resize();
                alert(positions);
            }
            function barramento_position(start,end){
                var startobj=$('[el="'+start+'"]');
                var endobj=$('[el="'+end+'"]');
    
                return {
                    'start':{
                        'x':$(startobj).offset().left+($(startobj).width()/2),
                        'y':$(startobj).offset().top+($(startobj).height()/2)
                    },
                    'end':{
                        'x':$(endobj).offset().left+($(endobj).width()/2),
                        'y':$(endobj).offset().top+($(endobj).height()/2)
                    }
                };
            }
            var u;
            function draw_barramento(){
                $('#fullcanvas').clearCanvas();
                $('[el]').each(function(){
                    var id=$(this).attr('el');
                    if($(this).attr('barramento')!=""){
                        var barramento = $(this).attr('barramento').split(',')
                        for(var i=0;i<barramento.length;i++){
                            if(barramento[i].trim()!=""){
                                ///var id_barramento=id+"_"+barramento[i];
                                var positions=barramento_position(id,barramento[i]);
                                //var obj=$('<canvas></canvas>').addClass('linecanvas').attr({'id':id_barramento}).css(positions.position);

                                var canvas_line=positions;
                                $('#fullcanvas').drawLine({
                                    strokeStyle: "#00ff00",
                                    strokeWidth: 3,
                                    x1: canvas_line.start.x, y1: canvas_line.start.y,
                                    x2: canvas_line.end.x, y2: canvas_line.end.y
                                })

                            }
                        }
                    }
                });
            }
            function ativar_barramento(start,end,flush){
                if(flush==undefined || flush){
                    draw_barramento();
                }
                var canvas_line=barramento_position(start,end);
                $('#fullcanvas').drawLine({
                    strokeStyle: "#000",
                    strokeWidth: 1,
                    x1: canvas_line.start.x, y1: canvas_line.start.y,
                    x2: canvas_line.end.x, y2: canvas_line.end.y
                });
            }
            (function($){
                $.fn.memoria = function(processador){
                    $(this).attr({'el':processador.memoria.nome,'pointer':processador.memoria.apontador_endereco,'barramento':''});
                    var memoriaObj = $('<table></table>').addClass('memoria').attr({'id':'memoria_principal'});
                    memoriaObj.append("<tr><td>ADD</td><td>VAL</td></tr>");
                    var memoria = processador.memoria.size;
                    var val="";
                    for(var i=0;i<memoria.toString().length;i++){
                        val+="0"
                    }
                    for(var i=0;i<memoria;i++){
                        memoriaObj.append("<tr><td>"+i+"</td><td arr='"+i+"'>"+val+"</td></tr")
                    }
                    $(this).append(memoriaObj);
                }
                $.fn.numberkeyboard=function(processador){
                    var divContainer=$('div').addClass('numberkeyboard');
                    $('body').append(divContainer);
                    var input=$('<input class="valor" id="valor" disabled="disabled">');
                    var backspace=$('<a class="backspace"></a>').click(function(){
                        var valor = input.val();
                        input.val(valor.substr(0,(valor.length-1)));
                    });
                    divContainer.append(input);
                    divContainer.append(backspace);
                    for(var i=0;i<10;i++){
                        divContainer.append('<a class="number" val="'+i+'">'+i+'</a>').click(function(){
                            var valor=$(this).attr('val');
                            input.val(input.val()+""+valor);
                        });
                    }
                    divContainer.append('<a class="confirm"></a>').click(function(){
                        $('[barramento="per"]').html(input.val());
                    });
                    return $(this);
                }
                $.fn.registrador=function(reg){
                    var memoria = reg.size;
                    var val="";
                    for(var i=0;i<memoria.toString().length;i++){
                        val+="0"
                    }
                    var el_reg=$('<div></div>').attr({'el':reg.nome,'pointer':'',l:reg.orientacao.x,'barramento':reg.barramento}).addClass('registrador draggable').css({'top':reg.orientacao.y,'left':reg.orientacao.x});
                    el_reg.append($('<div></div').addClass('nome').html(reg.nome_exibicao));
                    el_reg.append($('<div></div>').addClass('valor').html(val));
                    $(this).append(el_reg);
                }
                $.fn.gravar=function(value){
                    var pointer=$(this).attr('pointer');
                    if(pointer!=''){
                        var indicador=$('[el="'+pointer+'"]').ler();
                        $(this).find('[arr="'+indicador+'"]').html(value);
                    }else{
                        $(this).find('.valor').html(value);
                    }
                }
                $.fn.ler=function(){
                    var pointer=$(this).attr('pointer');
                    if(pointer!=''){
                        var indicador=$('[el="'+pointer+'"]').ler();
                        return $(this).find('[arr="'+indicador+'"]').html();
                    }else{
                        return $(this).find('.valor').html();
                    }
                }
                $.fn.auxiliares=function(reg){
                    
                    var memoria = reg.size;
                    var val="";
                    for(var i=0;i<memoria.toString().length;i++){
                        val+="0"
                    }
                    var el_reg=$('<div></div>').attr({'el':reg.nome,'pointer':reg.apontador_endereco,l:reg.orientacao.x,'barramento':reg.barramento}).addClass('registrador_auxiliar draggable').css({'top':reg.orientacao.y,'left':reg.orientacao.x});
                    var reg_tbl=$('<table></table>');
                    reg_tbl.append("<tr><td colspan='2'>"+reg.nome_exibicao+"</td></tr>");
                    reg_tbl.append("<tr><td>ADD</td><td>VAL</td></tr>");
                    
                    for(var i=0;i<reg.arr;i++){
                        reg_tbl.append("<tr><td>"+i+"</td><td arr='"+i+"'>"+val+"</td></tr")
                    }
                    el_reg.append(reg_tbl);
                    $(this).append(el_reg);
                }
                $.fn.unidade_funcional=function(unidade){
                    var unidadeObj=$('<div></div>').attr({'el':unidade.nome,'pointer':'',l:unidade.style.left,'barramento':''}).addClass('unidade_funcional draggable').css(unidade.style);
                    var regs=unidade.elementos;
                    for(var i=0;i<regs.length;i++){
                        var memoria = regs[i].size;
                        var val="";
                        for(var u=0;u<memoria.toString().length;u++){
                            val+="0"
                        }
                        var min_reg=$('<div></div>')
                        .attr({'el':regs[i].nome,'pointer':'','barramento':regs[i].barramento})
                        .addClass('registrador')
                        .css(regs[i].style);
                        
                        min_reg.append($('<div></div').addClass('nome').html(regs[i].nome_exibicao));
                        min_reg.append($('<div></div>').addClass('valor').html(val));
                        
                        unidadeObj.append(min_reg)
                    }
                    $(this).append(unidadeObj);
                }
                $(window).resize(function(){
                    var left= Math.ceil($('#processador').offset().left);
                    /*$('.draggable').each(function(){
                        var atualeft= Math.ceil($(this).attr('l'))+left;
                        $(this).css('left',atualeft);
                    });*/
                });
            })(jQuery)
            var col="";
            $(document).ready(function(){
                $('#memoria').memoria(processador)
                var registradores=processador.registradores;
                for(var i=0;i<registradores.length;i++){
                    $('#processador').registrador(registradores[i]);
                }
                var registradoresaux=processador.registradores_auxilixares;
                for(var i=0;i<registradoresaux.length;i++){
                    $('#processador').auxiliares(registradoresaux[i]);
                }
                var unidades_funcionais=processador.unidades_funcional;
                for(var i=0;i<unidades_funcionais.length;i++){
                    $('#processador').unidade_funcional(unidades_funcionais[i]);
                }
                $('[el="per"]').attr('pointer',processador.apontador_ees);
                draw_barramento();
                $(window).resize();
            });
        </script>
    </head>
    <body>
        <div id="computador">
            <canvas id="fullcanvas" height="8000" width="8000"></canvas>
            <div id="memoria"></div>
            <div id="processador"></div>
            <div id="unidade_controle">
                <div id="clock_area">
                    <a class="button" subclock="">-</a>
                    <input disabled="disabled" type="text" id="clock" value="100" style="width: 35px;"/>
                    <a class="button" addclock="">+</a>
                </div>
                <a class="button" onclick="start_processamento()">Start</a>
                <a class="button" onclick="stop_processamento()">Pause</a>
                <script>
                    $(document).ready(function(){
                        var started=false;
                        $('[addclock]').click(function(){
                            if(!started)
                                $('#clock').val(parseInt($('#clock').val())+10);
                        });
                        $('[subclock]').click(function(){
                            if(!started)
                                $('#clock').val(parseInt($('#clock').val())-10);
                        });
                        
                        valor('em',0);
                        valor('mem',6);
                        valor('em',1);
                        valor('mem',10);
                        valor('em',2);
                        valor('mem',0);
                        valor('em',3);
                        valor('mem',0);
                        valor('em',4);
                        valor('mem',23);
                        valor('em',5);
                        valor('mem',0);
                    });
                    var timmer;
                    function start_processamento(){
                        if(parseInt($('[el="per"]').attr('qtd'))==0){
                            if(!confirm("Seu programa realmente não possue perifericos?"))
                                return false;
                        }
                        console.log("start");
                        started=true;
                        clock();
                    }
                    function stop_processamento(){
                        console.log("stop");
                        started=false;
                        window.clearInterval(timmer);
                    }
                    function clock(){
                        timmer = window.setInterval(function(){
                            pulso();
                        },parseInt($('#clock').val()));
                    }
                    var controle_operacao=0;
                    var startfunction=true;
                    function pulso(){
                        if(controle_operacao==0){
                            if(startfunction){
                                controle_operacao=$(processador.startfunction).length-1;
                                console.log("processador.logica."+processador.startfunction[0]);
                                eval("processador.logica."+processador.startfunction[0]);
                                if(controle_operacao==0){
                                    startfunction=false;
                                }
                            }else{
                                controle_operacao=processador.funcoes[valor(processador.registrador_operando)].length-1;
                                console.log("processador.logica."+processador.funcoes[valor(processador.registrador_operando)][0]);
                                eval("processador.logica."+processador.funcoes[valor(processador.registrador_operando)][0]);
                                if(controle_operacao==0){
                                    startfunction=true;
                                }
                            }
                        }else{
                            if(startfunction){
                                var len=processador.startfunction.length;
                                var posicao_atual=len-controle_operacao;
                                console.log("processador.logica."+processador.startfunction[posicao_atual]);
                                eval("processador.logica."+processador.startfunction[posicao_atual]);
                                controle_operacao--;
                                if(controle_operacao==0){
                                    startfunction=false;
                                }
                            }else{
                                var len = processador.funcoes[valor(processador.registrador_operando)].length;
                                var posicao_atual=len-controle_operacao;
                                console.log("processador.logica."+processador.funcoes[valor(processador.registrador_operando)][posicao_atual]);
                                eval("processador.logica."+processador.funcoes[valor(processador.registrador_operando)][posicao_atual]);
                                controle_operacao--;
                                if(controle_operacao==0){
                                    startfunction=true;
                                }
                            }
                        }
                    }
                    
                </script>
                <script src="programateste.js"></script>
            </div>
            <div id="perifericos">
                <table el="per" barramento="" qtd="0">
                    <tr>
                        <td>
                            <select id="tipo_periferico" name="tipo_periferico">
                                <option value="display">Display</option>
                                <option value="numberkeypad">Number Key Pad</option>
                            </select>
                        </td>
                        <td>
                            <button id="ADD_periferico">Add</button>
                            <script>
                                $('#ADD_periferico').click(function(){
                                    var atu=parseInt($('[el="per"]').attr('qtd'));
                                    var tipo = $('#tipo_periferico').val();
                                    $('[el="per"]').append('<tr><td>'+atu+':'+tipo+'</td><td arr="'+atu+'" tipo="'+tipo+'">0</td></tr>');
                                    $('[el="per"]').attr('qtd',++atu);
                                });
                                $.fn.display=function(){
                                    stop_processamento();
                                    var value = $(this).html();
                                    var box=$('<div>').css({
                                        'position':'fixed',
                                        'top':0,
                                        'left':0,
                                        'right':0,
                                        'bottom':0,
                                        'background-color':'rgba(0,0,0,0.5)',
                                        'color':'#00ff00',
                                        'z-index':2000
                                    }).html(value);
                                    var button = $('<span>').addClass('button').html('Close').click(function(){
                                        box.remove();
                                        start_processamento();
                                    });
                                    $('body').append(box);
                                    box.append(button);
                                }
                                $.fn.numberkeypad=function(para){
                                    stop_processamento();
                                    var obj=$(this);
                                    $(this).html(0);
                                    var input = $('<input>').attr({
                                        'disabled':true,
                                        'type':'text'
                                    });
                                    var box=$('<div>').css({
                                        'position':'fixed',
                                        'top':0,
                                        'left':0,
                                        'right':0,
                                        'bottom':0,
                                        'background-color':'rgba(0,0,0,0.5)',
                                        'color':'#00ff00',
                                        'z-index':2000
                                    });
                                    var button = $('<span>').addClass('button').html('Close').click(function(){
                                        obj.html(input.val());
                                        $('[el="'+para+'"]').gravar(input.val());
                                        box.remove();
                                        start_processamento();
                                    });
                                    $('body').append(box);
                                    box.append(input);
                                    for(var i=0;i<10;i++){
                                        var btn = $('<span>').addClass('button').html(i).click(function(){
                                           input.val(input.val()+""+$(this).html()); 
                                        });
                                        box.append(btn);
                                    }
                                    box.append(button)
                                }
                                
                            </script>
                        </td>    
                    </tr>
                </table>
            </div>
        </div>
    </body>
</html>
